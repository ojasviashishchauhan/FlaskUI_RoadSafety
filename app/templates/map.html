{% extends "base.html" %}

{% block title %}Map View - RoadAISafety{% endblock %}

{% block styles %}
<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/css/ol.css" type="text/css">

<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .disclaimer {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 1rem;
    }
    .popup-content {
        text-align: center;
        max-width: 200px;
    }
    .popup-content img {
        max-width: 100%;
        height: auto;
        margin-bottom: 8px;
        border-radius: 4px;
    }
    .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
        display: none;
    }
    .ol-popup.visible {
        display: block;
    }
    .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
    }
    .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
    }
    .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-3">Image Locations</h2>
    <p class="disclaimer">Note: This map uses ISRO's Bhuvan service and follows Survey of India guidelines.</p>
    
    {% if not images %}
    <div class="alert alert-info">
        No images with location data available.
    </div>
    {% endif %}
    
    <div id="map"></div>
    <div id="popup" class="ol-popup">
        <div id="popup-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- OpenLayers JavaScript -->
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/build/ol.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create the popup overlay
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    });

    // Define the extent for India (including disputed territories)
    var indiaExtent = ol.proj.transformExtent([68.1766, 6.2325, 97.4025, 37.5], 'EPSG:4326', 'EPSG:3857');

    // Create the map with Bhuvan WMS layer
    var map = new ol.Map({
        target: 'map',
        overlays: [overlay],
        layers: [
            new ol.layer.Tile({
                source: new ol.source.TileWMS({
                    url: '/bhuvan-proxy',
                    params: {
                        'LAYERS': 'india3',
                        'FORMAT': 'image/png',
                        'TRANSPARENT': true
                    },
                    serverType: 'geoserver',
                    crossOrigin: 'anonymous',
                    projection: 'EPSG:4326',
                    tileGrid: new ol.tilegrid.TileGrid({
                        extent: [-180, -90, 180, 90],
                        resolutions: Array.from({length: 19}, (_, i) => 360 / (256 * Math.pow(2, i))),
                        tileSize: [256, 256],
                        origin: [-180, 90]
                    })
                })
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([78.9629, 20.5937]), // Center of India
            zoom: 5,
            minZoom: 4,
            maxZoom: 18,
            extent: indiaExtent,
            constrainOnlyCenter: true
        })
    });

    // Add markers for images
    var features = [];
    {% for image in images %}
        {% if image.metadata and image.metadata.gps_latitude and image.metadata.gps_longitude %}
            var feature = new ol.Feature({
                geometry: new ol.geom.Point(
                    ol.proj.fromLonLat([{{ image.metadata.gps_longitude }}, {{ image.metadata.gps_latitude }}])
                ),
                name: "{{ image.filename }}",
                image_id: "{{ image._id }}"
            });
            features.push(feature);
        {% endif %}
    {% endfor %}

    // Create vector source and layer for markers
    var vectorSource = new ol.source.Vector({
        features: features
    });

    var vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 8,
                fill: new ol.style.Fill({color: '#3388ff'}),
                stroke: new ol.style.Stroke({color: '#fff', width: 2})
            })
        })
    });

    map.addLayer(vectorLayer);

    // Add click handler for features
    map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature;
        });

        if (feature) {
            var coordinates = feature.getGeometry().getCoordinates();
            var popupContent = '<div class="popup-content">' +
                '<p>' + feature.get('name') + '</p>' +
                '<a href="/image/' + feature.get('image_id') + '" class="btn btn-sm btn-primary">View Details</a>' +
                '</div>';
            
            content.innerHTML = popupContent;
            container.classList.add('visible');
            overlay.setPosition(coordinates);
        } else {
            container.classList.remove('visible');
            overlay.setPosition(undefined);
        }
    });

    // Change mouse cursor when over marker
    map.on('pointermove', function(e) {
        if (e.dragging) return;
        
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.hasFeatureAtPixel(pixel);
        var mapElement = map.getTargetElement();
        if (mapElement) {
            mapElement.style.cursor = hit ? 'pointer' : '';
        }
    });

    // Fit to markers if they exist
    if (features.length > 0) {
        var extent = vectorSource.getExtent();
        map.getView().fit(extent, {
            padding: [50, 50, 50, 50],
            maxZoom: 12
        });
    }
});
</script>
{% endblock %}