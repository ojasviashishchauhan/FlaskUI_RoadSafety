{% extends "base.html" %}

{% block title %}Road Segment Damage Analysis{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    #map-container {
        height: 600px;
        width: 100%;
        margin-bottom: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    #region-map {
        height: 100%;
        width: 100%;
    }

    .cluster-card {
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .cluster-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        font-weight: bold;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .severity-high {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .severity-medium {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
    }

    .severity-low {
        background-color: #d1e7dd;
        border-color: #badbcc;
        color: #0f5132;
    }

    .stats-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        flex: 1;
        min-width: 250px;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: white;
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card h3 {
        margin-top: 0;
        color: #495057;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: #212529;
    }

    .filter-controls {
        margin-bottom: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-section {
        margin-bottom: 15px;
    }

    .filter-title {
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .cluster-list {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .no-data-message {
        text-align: center;
        padding: 50px 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-top: 50px;
    }

    .map-tooltip {
        background-color: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 6px;
        padding: 15px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.25);
        max-width: 300px;
    }

    .map-tooltip h5 {
        margin-top: 0;
        margin-bottom: 12px;
        color: #212529;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 8px;
    }

    .map-tooltip-content {
        font-size: 14px;
        color: #495057;
    }

    .cluster-details {
        padding: 15px;
    }

    .cluster-section {
        margin-bottom: 12px;
    }

    .damage-type-badge {
        display: inline-block;
        padding: 3px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .btn-view-cluster {
        width: 100%;
        margin-top: 10px;
    }
    
    .road-segment-card {
        background-color: white;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .road-segment-header {
        padding: 15px;
        background-color: #e9ecef;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .road-segment-body {
        padding: 15px;
    }
    
    .damage-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .damage-metric {
        flex: 1;
        min-width: 120px;
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
    }
    
    .damage-metric-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .damage-metric-label {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .contractor-info {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 10px 15px;
        margin-top: 10px;
    }
    
    .segment-chart-container {
        height: 200px;
        margin: 15px 0;
    }
    
    .polyline-legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    
    .polyline-legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .polyline-legend-color {
        width: 20px;
        height: 3px;
        margin-right: 8px;
    }

    /* --- Add styles for new layout --- */
    .segment-card-hover:hover {
        border-color: var(--bs-primary);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    }

    /* Make text in cluster cards black, overriding severity colors */
    .cluster-card .card-header,
    .cluster-card .card-body,
    .cluster-card .card-body strong,
    .cluster-card .card-body span,
    .cluster-card .card-body div {
        color: #212529 !important; /* Use a standard dark text color and !important to override */
    }

    /* Keep background colors for severity */
    .severity-high { background-color: #f8d7da; border-color: #f5c6cb; }
    .severity-medium { background-color: #fff3cd; border-color: #ffeeba; }
    .severity-low { background-color: #d1e7dd; border-color: #badbcc; }
    
    /* Ensure badges within cards also have dark text */
    .cluster-card .badge {
        color: #212529 !important;
    }
    .cluster-card .badge.bg-secondary {
         background-color: #e9ecef !important; /* Lighter secondary for contrast */
         border: 1px solid #ced4da;
    }
    .cluster-card .badge.bg-light {
        color: #212529 !important; /* Ensure light badges have dark text */
    }

    /* Remove hover effects if desired, or adjust */
    /* .cluster-card:hover { transform: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); } */
    /* --- End new styles --- */

    @media (max-width: 768px) {
        .stats-container {
            flex-direction: column;
        }
        
        .stat-card {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1><i class="fas fa-chart-area me-2"></i>Road Segment Damage Analysis</h1>
    <p>Clusters of detected road damage based on geographic proximity.</p>

    {% if has_data %}
        {# Filter Controls #}
        <div class="filter-controls card mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('region_analytics') }}">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="distance" class="form-label filter-title"><i class="fas fa-ruler-horizontal me-1"></i>Clustering Distance (km)</label>
                            <input type="number" class="form-control" id="distance" name="distance" value="{{ cluster_distance }}" step="0.1" min="0.1">
                        </div>
                        <div class="col-md-3">
                            <label for="severity" class="form-label filter-title"><i class="fas fa-exclamation-triangle me-1"></i>Severity</label>
                            <select class="form-select" id="severity" name="severity">
                                <option value="all" {% if selected_severity == 'all' %}selected{% endif %}>All Severities</option>
                                <option value="low" {% if selected_severity == 'low' %}selected{% endif %}>Low</option>
                                <option value="medium" {% if selected_severity == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="high" {% if selected_severity == 'high' %}selected{% endif %}>High</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="damage_type" class="form-label filter-title"><i class="fas fa-tools me-1"></i>Damage Type</label>
                            <select class="form-select" id="damage_type" name="damage_type">
                                <option value="all" {% if selected_damage_type == 'all' %}selected{% endif %}>All Damage Types</option>
                                {# Dynamically populate other options based on available types? #}
                                {# Or use common types #}
                                <option value="Crack" {% if selected_damage_type == 'Crack' %}selected{% endif %}>Crack</option>
                                <option value="Pothole" {% if selected_damage_type == 'Pothole' %}selected{% endif %}>Pothole</option>
                                <option value="Rutting" {% if selected_damage_type == 'Rutting' %}selected{% endif %}>Rutting</option>
                                <option value="Alligator Cracking" {% if selected_damage_type == 'Alligator Cracking' %}selected{% endif %}>Alligator Cracking</option>
                                <option value="Edge Defect" {% if selected_damage_type == 'Edge Defect' %}selected{% endif %}>Edge Defect</option>
                                {# Add other common types as needed #}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i>Apply</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="row">
            {# REMOVE Map Container #}
            {# <div class=\"col-lg-7 mb-4\">
                <div id=\"map-container\">
                    <div id=\"region-map\"></div>
                </div>
            </div> #}

            {# Cluster List - Make it full width #}
            <div class="col-lg-12">
                <h4>Identified Road Segments ({{ clusters|length }})</h4>
                {# Adjust max-height if needed #}
                <div class="cluster-list row" style="max-height: 75vh; overflow-y: auto;">
                    {% if clusters %}
                        {% for cluster in clusters %}
                            <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                                <div class="card cluster-card h-100">
                                    <div class="card-header severity-{{ cluster.severity or 'low' }}">
                                        {{ cluster.name or ('Segment ' ~ cluster.id) }}
                                        <span class="badge bg-secondary">{{ cluster.point_count }} Image{{ 's' if cluster.point_count != 1 }}</span>
                                    </div>
                                    <div class="card-body cluster-details">
                                        <div class="cluster-section"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Center: {{ "%.5f"|format(cluster.center.lat) }}, {{ "%.5f"|format(cluster.center.lng) }}</div>
                                        <div class="cluster-section"><i class="fas fa-exclamation-circle me-2 text-danger"></i>Primary Damage: <strong>{{ cluster.primary_damage }}</strong></div>
                                        <div class="cluster-section"><i class="fas fa-thermometer-half me-2 text-warning"></i>Avg. Confidence: {{ "%.1f"|format(cluster.avg_confidence) }}%</div>
                                        <div class="cluster-section"><i class="fas fa-ruler-combined me-2 text-info"></i>Severity: <span class="text-capitalize fw-bold">{{ cluster.severity }}</span></div>
                                        <div class="cluster-section"><i class="fas fa-tags me-2 text-success"></i>Damage Types:
                                            {% for type, count in cluster.damage_types.items() %}
                                                <span class="badge bg-light text-dark border me-1">{{ type }}: {{ count }}</span>
                                            {% else %}
                                                None
                                            {% endfor %}
                                        </div>
                                        {# -- FIX VIEW ON MAP LINK -- #}
                                        <a href="{{ url_for('map_view', lat=cluster.center.lat, lon=cluster.center.lng, zoom=15) }}" 
                                           class="btn btn-outline-primary btn-sm mt-2 btn-view-cluster" 
                                           target="_blank"  {# Opens in new tab #}
                                           title="View this segment location on the main map">
                                            <i class="fas fa-map-marked-alt me-1"></i>View on Map
                                        </a>
                                        {# -- END FIX -- #}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No road segments match the current filters.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# REMOVE STATE STATS SECTION (If any) #}
        {# Assuming state stats might have been displayed in a separate section or table. #}
        {# If there was a specific block iterating `state_stats`, it would be removed here. #}
        {# Since it wasn't obvious in the initial read, and we removed it from the backend, #}
        {# we ensure no new elements rely on it. #}

    {% else %}
        <div class="no-data-message alert alert-info">
            <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i>No Data Available</h4>
            <p>There is currently no regional damage data to display. This could be because:</p>
            <ul>
                <li>No images with location data have been processed yet.</li>
                <li>No processed images have detected damage.</li>
            </ul>
            <hr>
            <p class="mb-0">Please upload and process images with geographic coordinates to enable this analysis.</p>
        </div>
    {% endif %}
</div>
{% endblock %} 