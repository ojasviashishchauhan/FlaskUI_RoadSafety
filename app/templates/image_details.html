{% extends "base.html" %}

{% block title %}Image Details - {{ image.original_filename or image.filename }}{% endblock %}

{% block styles %}
{{ super() }}
{# Include Leaflet CSS only if location data exists #}
{% if image.location and image.location.latitude and image.location.longitude %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 300px;
        width: 100%;
        border-radius: 0.25rem;
        margin-top: 1rem;
    }
</style>
{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            {# Display original filename if available, otherwise the generated one #}
            <h2 class="mb-0">Details: {{ image.original_filename or image.filename }}</h2>
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>

    {% if image.processing_status == 'failed' %}
        <div class="alert alert-danger">
            <strong>Processing Failed:</strong> {{ image.error_message }}
        </div>
    {% elif image.processing_status == 'processing' %}
        <div class="alert alert-info">Image processing is currently in progress...</div>
    {% elif image.processing_status == 'pending' %}
         <div class="alert alert-secondary">Image processing is pending...</div>
    {% endif %}

    <div class="row">
        <!-- Image Display (Prioritize Annotated) -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ 'Annotated Image' if image.annotated_image_path else 'Original Image' }}</h5>
                </div>
                <div class="card-body text-center p-2">
                    {% set display_image_path = image.annotated_image_path or image.file_path %}
                    {% set display_image_filename = image.annotated_image_path.split('/')[-1] if image.annotated_image_path else image.filename %}
                    {% if display_image_filename %}
                        <img src="{{ url_for('view_image', filename=display_image_filename) }}" 
                             class="img-fluid rounded" 
                             alt="{{ 'Annotated Image' if image.annotated_image_path else 'Original Image' }}"
                             style="max-height: 60vh;">
                    {% else %}
                        <p class="text-muted">Image file not available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Details Column -->
        <div class="col-md-5">
            <!-- Key Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Key Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            {% if image.processing_status == 'completed' %}<span class="badge bg-success">Complete</span>
                            {% elif image.processing_status == 'processing' %}<span class="badge bg-warning text-dark">Processing</span>
                            {% elif image.processing_status == 'pending' %}<span class="badge bg-secondary">Pending</span>
                            {% elif image.processing_status == 'failed' %}<span class="badge bg-danger">Failed</span>
                            {% else %}<span class="badge bg-secondary">{{ image.processing_status|title }}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Uploaded</dt>
                        <dd class="col-sm-8">{{ image.upload_time.strftime('%Y-%m-%d %H:%M') if image.upload_time else 'N/A' }}</dd>

                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8">{{ image.image_type|title if image.image_type else 'N/A' }}</dd>
                        
                        {% if image.processing_time is not none %}
                        <dt class="col-sm-4">Proc. Time</dt>
                        <dd class="col-sm-8">{{ "%.2f"|format(image.processing_time) }}s</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Prediction Details Card - TEMPORARILY COMMENTED OUT FOR DEBUGGING -->
            <!--
            {% if image.processing_status == 'completed' %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Prediction Details</h5>
                </div>
                <div class="card-body">
                    {% if image.prediction_results and image.prediction_results.get('damage_detected', False) %}
                        <div class="mb-2">
                            <strong>Overall Confidence:</strong> 
                            {% if image.confidence_score is not none %}
                                {{ "%.1f"|format(image.confidence_score * 100) }}%
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <h6>Detected Objects:</h6>
                        {% if image.prediction_results.raw_predictions %}
                            <ul class="list-group list-group-flush">
                            {% for detection in image.prediction_results.raw_predictions %}
                                <li class="list-group-item px-0">
                                    <strong>Type:</strong> {{ detection.class_name|title }} <br> {# Use class_name from predictor #}
                                    <strong>Confidence:</strong> {{ "%.1f"|format(detection.confidence * 100) }}% <br>
                                    <strong>Box:</strong> {{ detection.bbox|map('int')|list }} <br> {# Use bbox from predictor #}
                                    {# Display Polygon simplified #}
                                    {% if detection.mask %}
                                        <strong>Polygon Points:</strong> {{ detection.mask|length }} <br>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No specific objects detected.</p>
                        {% endif %}
                    {% elif image.prediction_results %}
                        <p class="text-success mb-0">No damage detected.</p>
                    {% else %}
                        <p class="text-muted mb-0">Prediction results not available.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            -->
            <!-- END TEMPORARY COMMENT OUT -->

            <!-- Metadata & Location Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Metadata & Location</h5>
                </div>
                <div class="card-body">
                    {% if image.metadata %}
                        <h6>Metadata:</h6>
                        <dl class="row mb-2">
                            {% for key, value in image.metadata.items() %}
                                {# Exclude lat/lon if already shown in location #}
                                {% if not (key == 'latitude' or key == 'longitude') or not image.location %}
                                    <dt class="col-sm-5 text-truncate" title="{{ key }}">{{ key|replace('_', ' ')|title }}</dt>
                                    <dd class="col-sm-7">{{ value }}</dd>
                                {% endif %}
                            {% endfor %}
                        </dl>
                    {% endif %}
                    
                    {% if image.location and image.location.latitude and image.location.longitude %}
                        <h6 class="mt-3">Location:</h6>
                        <p class="mb-1">
                            Lat: {{ image.location.latitude }}, Lon: {{ image.location.longitude }}
                        </p>
                        {% if image.location.address %}
                        <p class="text-muted small mb-0">{{ image.location.address }}</p>
                        {% endif %}
                        <div id="map"></div> {# Map container #}
                    {% elif not image.metadata and not image.location %}
                         <p class="text-muted mb-0">No metadata or location data available.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Delete Button -->
            <div class="d-grid">
                <button type="button" class="btn btn-danger" onclick="confirmDeleteSingle('{{ image.id }}')">
                    <i class="fas fa-trash me-1"></i> Delete Image
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Leaflet JS for Map #}
{# Ensure we only run script if location data is valid #}
{% if image.location and image.location.latitude is not none and image.location.longitude is not none %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Assign Flask/Jinja variables to JS constants *safely*
            // Use '|tojson' filter to handle potential quoting issues and None values
            const lat = {{ image.location.latitude|tojson }};
            const lon = {{ image.location.longitude|tojson }};
            
            // Check if coordinates are valid numbers
            if (typeof lat === 'number' && typeof lon === 'number') {
                const map = L.map('map').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
                }).addTo(map);
                L.marker([lat, lon]).addTo(map);
            } else {
                console.warn("Invalid coordinates received:", lat, lon);
                document.getElementById('map').innerHTML = '<p class="text-muted text-center">Map coordinates invalid.</p>';
            }
        } catch (e) {
            console.error("Error initializing map:", e);
            document.getElementById('map').innerHTML = '<p class="text-danger text-center">Error loading map.</p>';
        }
    });
</script>
{% endif %}

{# Delete Confirmation Script #}
<script>
function confirmDeleteSingle(imageId) {
    if (confirm('Are you sure you want to delete this image permanently?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{{ url_for('delete_image', image_id='IMAGE_ID_PLACEHOLDER') }}`.replace('IMAGE_ID_PLACEHOLDER', imageId);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 